{% load staticfiles %}

<style>
    #config-bar-show-button {
        position: fixed;
        right: -40px;
        top: 250px;
        width: 100px;
        transform: rotate(-90deg);
        -webkit-transform: rotate(-90deg);
        border: solid #808080 1px;
        margin: 0;
        padding: 10px;
        text-transform: capitalize;
        font-weight: bold;
        background-color: rgba(255, 255, 255, 0.8);
        transition: all 0.2s;
        cursor: pointer;
        text-align: center;
    }
    #config-bar-show-button:hover {
        background-color: #1f8dd6;
        color: white;
    }
    #config-bar {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 500px;
        border-left: solid #808080 1px;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 1000;
    }
    #config-bar-header {
        background-color: rgba(31, 141, 214, 0.8);
        margin: 0;
        padding: 10px 20px;
        text-align: right;
        color: white;
    }
    #config-bar-content .section {
        background-color: rgba(31, 141, 214, 0.8);
        margin: 0;
        padding: 10px 20px;
        color: white;
        text-transform: uppercase;
        cursor: pointer;
    }
    #config-bar-hide {
        text-align: right;
        width: 100%;
        cursor: pointer;
    }
    #config-bar-content {
        margin: 0;
        list-style: none;
        padding: 0;
    }
    #config-bar-content > li {
        border-bottom: 1px dashed #E9F4FB;
        padding: 10px 20px;
        margin: 0;
    }
    #config-bar-content > li:hover {
        background: #E9F4FB;
    }
    #config-bar-content .reset, #config-bar-content .add-to-override {
        cursor: pointer;
        font-weight: bolder;
    }
    #config-bar-content input {
        padding: 5px 10px;
    }
    #config-bar-content label {
        margin-left: 10px;
        cursor: pointer;
    }
    #config-bar-content .link {
        text-transform: uppercase;
        cursor: pointer;
        font-weight: bold;
    }
    #config-bar-logging {
        list-style: none;
        margin: 0;
        padding: 0;
        max-height: 500px;
        overflow-y: scroll;
        font-size: 12px;
    }
    #config-bar-logging > li {
        margin: 0;
        padding: 5px 10px;
        border-bottom: 1px solid #E9F4FB;
    }
    #config-bar-logging > li:hover {
        background-color: #E9F4FB;
    }
    #config-bar-logging .level {
        display: block;
        float: left;
        width: 10%;
        font-weight: bold;
    }
    #config-bar-logging .url {
        font-weight: bold;
        margin-left: 10px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 50%;
        float: left;
    }
    #config-bar-logging .filename {
        display: block;
        float: right;
        text-align: right;
        width: 30%;
        font-weight: bold;
    }
    #config-bar-logging .message {
        display: block;
        clear: both;
        margin-top: 20px;
        margin-bottom: 5px;
    }
    #config-bar-content input {
        font-size: 14px;
    }
    #config-bar-content .property-name {
        width: 70%;
    }
    #config-bar-content .property-value {
        width: 10%;
        text-align: center;
    }
    #config-bar-property-name {
        width: 70%;
    }
</style>

<script src="{% static "proso_common/angular/angular.min.js" %}"></script>
<script src="{% static "proso_common/angular/angular-cookies.min.js" %}"></script>
<script src="{% static "proso_common/js/config_service.js" %}"></script>
<script src="{% static "proso_common/js/logging_service.js" %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>


<script>
    var app = angular.module('proso_toolbar', ["proso_apps.services", "ngCookies"]);
    app.run(function(configService){
        configService.processConfig({{ config_json | safe }});
    });
    app.controller("toolbar", function($scope, $cookies, configService, loggingService){
        $scope.override = configService.override;
        $scope.removeOverridden = configService.removeOverridden;
        $scope.date = new Date();
        $scope.debugLog = [];
        $scope.opened = $cookies["toolbar:opened"] === "true";
        $scope.loggingOpened = true;
        $scope.override('debug', true);
        $scope.overridden = configService.getOverridden();
        loggingService.addDebugLogListener(function(events) {
            $scope.$apply(function(){
                events.forEach(function (e) {
                    $scope.debugLog.unshift(e);
                });
            });
        });

        $scope.$watch("opened", function(n, o){
            $cookies["toolbar:opened"] = n;
        });

        $scope.addToOverride = function(name) {
            if (!name) {
                return;
            }
            configService.override(name, '');
        };

        $scope.getOverridden = function() {
            var overridden = configService.getOverridden();
            Object.keys(overridden).filter(function(k) {
                return (k === 'user' || k === 'debug' || k === 'time');
            }).forEach(function (k) {
                delete overridden[k];
            });
            return overridden;
        };
    });
</script>
{% verbatim %}
<div id="proso-toolbar" ng-controller="toolbar">
    <div id="config-bar-show-button" ng-click="opened = !opened" ng-hide="opened"> proso bar </div>

    <div id="config-bar" ng-cloak ng-show="opened">
        <div id="config-bar-header">
            <span id="config-bar-hide" ng-click="opened = !opened">Close</span>
        </div>
        <ul id="config-bar-content">
            <li>
                <span ng-click="addToOverride(propertyToOverride)" class="add-to-override">+</span>
                <input type="text" ng-model="propertyToOverride" id="config-bar-property-name" placeholder="Property Name" />
            </li>
            <li>
                <span ng-click="removeOverridden('user'); overridden.user = null;" class="reset">X</span>
                <input type="number" ng-model="overridden.user" placeholder="User" ng-change="override('user', overridden.user)" />
            </li>
            <li>
                <span ng-click="removeOverridden('time'); overridden.time= null;" class="reset">X</span>
                <input type="text" ng-model="overridden.time" placeholder="Time" ng-change="override('time', overridden.time)" />
                <i>{{date | date:'yyyy-MM-dd_HH:mm:ss'}}</i>
            </li>
            <li ng-repeat="(name, value) in getOverridden() track by name">
                <span class="reset" ng-click="removeOverridden(name)">X</span>
                <input type="text" disabled class="property-name" ng-model="name" />
                <input type="text" class="property-value" placeholder="Value" ng-model="value" ng-change="override(name, value)" />
            </li>
            <div class='section' ng-click="loggingOpened = !loggingOpened">Logging</div>
            <ul id="config-bar-logging" ng-cloak ng-show="loggingOpened">
                <li ng-repeat="event in debugLog|limitTo:100" class="logging-event">
                    <span class="level">{{ event.level }}</span>
                    <span class="url">{{ event.url }}</span>
                    <span class="filename">{{ event.filename }}:{{ event.line_number }}</span>
                    <span class="message">{{ event.message }}</span>
                </li>
            </ul>
        </ul>
    </div>
</div>
{% endverbatim %}
<script>
    angular.bootstrap($("#proso-toolbar"), ["proso_toolbar"]);
</script>
